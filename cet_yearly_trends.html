<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>CET Yearly Temperature Trends</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<link rel="stylesheet" href="style.css">
<style>
.plot-container {
  background: white;
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  margin-bottom: 2rem;
}

#cet-yearly {
  width: 100%;
  height: 45vh;
  border-radius: 8px;
}

.info-section {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  margin-bottom: 2rem;
}

.info-section h3 {
  color: #2c3e50;
  margin-bottom: 1rem;
  border-bottom: 2px solid #667eea;
  padding-bottom: 0.5rem;
}

.info-section p {
  line-height: 1.6;
  color: #555;
  margin-bottom: 0.75rem;
}
</style>
</head>
<body>
<div class="banner">
  <a href="index.html">
    <img src="logo.svg" alt="WeatherArchives Logo" class="banner-logo">
  </a>
</div>

<nav class="nav-bar">
  <div class="nav-item">
    <a href="temperature.html" class="nav-link">Temperature</a>
    <div class="dropdown">
      <a href="temperature.html">Overview</a>
      <a href="cet_mean_daily_extremes.html">Daily Extremes</a>
      <a href="cet_monthly_averages.html">Monthly Averages</a>
      <a href="cet_seasonal_patterns.html">Seasonal Patterns</a>
      <a href="cet_yearly_trends.html">Yearly Trends</a>
      <a href="cet_compare_years.html">Compare Years</a>
    </div>
  </div>
  
  <div class="nav-item">
    <a href="wip.html" class="nav-link">Precipitation</a>
    <div class="dropdown">
      <a href="wip.html">Monthly Totals</a>
      <a href="wip.html">Seasonal Totals</a>
      <a href="wip.html">Yearly Totals</a>
      <a href="wip.html">Compare Years</a>
    </div>
  </div>
  
  <div class="nav-item">
    <a href="wip.html" class="nav-link">Sunshine</a>
    <div class="dropdown">
      <a href="wip.html">Monthly Hours</a>
      <a href="wip.html">Seasonal Hours</a>
      <a href="wip.html">Yearly Totals</a>
    </div>
  </div>
  
  <div class="nav-item">
    <a href="wip.html" class="nav-link">Fun & Learning</a>
    <div class="dropdown">
      <a href="wip.html">Creating your own weather forecast</a>
    </div>
  </div>
  
  <div class="nav-item">
    <a href="about.html" class="nav-link">About</a>
    <div class="dropdown">
      <a href="about.html">Data Sources</a>
      <a href="about.html">Methodology</a>
      <a href="about.html">References</a>
      <a href="about.html">Contact</a>
    </div>
  </div>
</nav>

<div class="title-banner">
  <h1>Central England Temperature Yearly Trends</h1>
  <p>Explore annual temperature trends and long-term climate patterns</p>
</div>

<div class="container">
  <div class="controls">
    <div class="control-group">
      <label>Dataset:</label>
      <select id="dataset-select">
        <option value="MeanTempCET.csv">Mean Temperature</option>
        <option value="MaxTempCET.csv">Maximum Temperature</option>
      </select>
    </div>
    

    
    <button id="export-yearly-btn">Download Image</button>
  </div>
  
  <div class="controls">
    <div class="control-group">
      <label>Year Range:</label>
      <input type="number" id="year-start" min="1772" max="2025" value="1772" style="width: 80px;">
      <span style="color: #666;">to</span>
      <input type="number" id="year-end" min="1772" max="2025" value="2025" style="width: 80px;">
      <button onclick="applyYearFilter()">Apply Filter</button>
    </div>
  </div>
  
  <div class="controls">
    <div class="control-group">
      <label style="margin-right: 1rem;">Show:</label>
      <label style="margin-right: 1rem;">
        <input type="checkbox" id="show-trend" checked> Trend Line
      </label>
      <label style="margin-right: 1rem;">
        <input type="checkbox" id="show-extremes" checked> Max/Min Years
      </label>
      <label>
        <input type="checkbox" id="show-data-points" checked> Data Points
      </label>
    </div>
  </div>

  <div class="plot-container">
    <div id="cet-yearly"></div>
  </div>
  
  <div class="info-section">
    <h3>Annual Temperature Analysis</h3>
    <p>This visualization shows annual temperature trends over the entire dataset, providing a comprehensive view of long-term climate patterns. Each data point represents the average temperature for an entire calendar year.</p>
    <p><strong>Interactive Features:</strong> Click on any data point to see detailed information about that year's temperature. The visualization will show annotations with the exact year and temperature value.</p>
    <p><strong>Trend Analysis:</strong> Look for patterns in how annual temperatures have changed over time. The trend line shows the overall direction of temperature change.</p>
  </div>

  <div class="info-section">
    <h3>Climate Context</h3>
    <p><strong>Annual Averages:</strong> Shows the average temperature for each calendar year (January to December), providing the most comprehensive view of yearly climate patterns.</p>
    <p><strong>Long-term Record:</strong> This data spans over 250 years, providing one of the longest continuous temperature records in the world. It's invaluable for understanding long-term climate patterns and detecting climate change signals.</p>
    <p><strong>Climate Change Analysis:</strong> The annual view is particularly useful for identifying long-term warming or cooling trends, as it smooths out seasonal variations and focuses on year-to-year changes.</p>
  </div>
</div>

<script>
// --- Linear regression function ---
function linearRegression(x, y) {
    const n = x.length;
    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
    
    for (let i = 0; i < n; i++) {
        sumX += x[i];
        sumY += y[i];
        sumXY += x[i] * y[i];
        sumX2 += x[i] * x[i];
    }
    
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    
    return { slope, intercept };
}

// --- Flexible date parsing for both formats ---
function parseFlexibleDate(dateStr) {
    if (!dateStr) return null;
    if (dateStr.includes('-')) { let dt = new Date(dateStr); if (!isNaN(dt)) return dt; }
    if (dateStr.includes('/')) {
        let dmy = dateStr.split('/'); if (dmy.length === 3) {
            let [dd, mm, yyyy] = dmy; dd=+dd; mm=+mm; yyyy=+yyyy;
            if (isNaN(dd) || isNaN(mm) || isNaN(yyyy)) return null;
            return new Date(yyyy, mm-1, dd);
        }
    }
    return null;
}

// --- Annual plot with enhanced features ---
function plotYearly(data) {
    let yearly_data = {};
    
    data.forEach(row => {
        let dt = parseFlexibleDate(row[0]), v = parseFloat(row[1]);
        if (!dt || isNaN(v)) return;
        let y = dt.getFullYear();
        
        if (!yearly_data[y]) yearly_data[y] = [];
        yearly_data[y].push(v);
    });
    
    // Calculate averages and apply year filter
    let years = [], values = [];
    Object.keys(yearly_data).sort().forEach(yr => {
        const year = +yr;
        if (year >= yearFilter.start && year <= yearFilter.end && yearly_data[yr].length > 0) {
            years.push(year);
            const avg = yearly_data[yr].reduce((a, b) => a + b, 0) / yearly_data[yr].length;
            values.push(avg);
        }
    });
    
    let traces = [];
    
    // Main data trace
    if (document.getElementById('show-data-points').checked) {
        traces.push({
            x: years,
            y: values,
            mode: 'lines+markers',
            name: 'Annual Average',
            line: { color: '#667eea', width: 3 },
            marker: { size: 4, color: '#667eea' }
        });
    } else {
        traces.push({
            x: years,
            y: values,
            mode: 'lines',
            name: 'Annual Average',
            line: { color: '#667eea', width: 3 }
        });
    }
    
    // Trend line
    if (document.getElementById('show-trend').checked && years.length > 1) {
        const { slope, intercept } = linearRegression(years, values);
        const trendY = years.map(x => slope * x + intercept);
        
        traces.push({
            x: years,
            y: trendY,
            mode: 'lines',
            name: 'Trend Line',
            line: { color: 'red', width: 2, dash: 'dash' },
            showlegend: true
        });
    }
    
    // Max and min year markers
    if (document.getElementById('show-extremes').checked && values.length > 0) {
        const maxIndex = values.indexOf(Math.max(...values));
        const minIndex = values.indexOf(Math.min(...values));
        
        traces.push({
            x: [years[maxIndex]],
            y: [values[maxIndex]],
            mode: 'markers',
            name: 'Warmest Year',
            marker: { 
                color: 'orange', 
                size: 10, 
                symbol: 'star',
                line: { color: 'black', width: 1 }
            },
            showlegend: true
        });
        
        traces.push({
            x: [years[minIndex]],
            y: [values[minIndex]],
            mode: 'markers',
            name: 'Coldest Year',
            marker: { 
                color: 'blue', 
                size: 10, 
                symbol: 'star',
                line: { color: 'black', width: 1 }
            },
            showlegend: true
        });
    }
    
    let layout = {
        title: `Annual Temperature Trends (${yearFilter.start}-${yearFilter.end})`,
        xaxis: { title: 'Year', showgrid: true, zeroline: false },
        yaxis: { title: 'Temperature (°C)', showgrid: true, zeroline: false },
        height: 500,
        margin: { l: 60, r: 30, t: 60, b: 60 },
        hovermode: 'x unified',
        showlegend: true
    };
    
    Plotly.newPlot('cet-yearly', traces, layout, {responsive: true});
    
    let curAnn = null;
    document.getElementById('cet-yearly').on('plotly_click', d => {
        let pt = d.points[0], ann = {
            x: pt.x, y: pt.y,
            text: `<b>${pt.x}</b><br>${pt.y.toFixed(2)}°C`, 
            showarrow: true,
            font: {color: '#667eea'}, 
            arrowcolor: '#667eea',
            ax: 0, ay: -30, bgcolor: '#fff'
        };
        let updates = curAnn ? {annotations: []} : {};
        Plotly.relayout('cet-yearly', updates);
        Plotly.relayout('cet-yearly', {annotations: [ann]});
        curAnn = ann;
    });
}



// --- Load CSV and plot ---
let currentDataset = 'MeanTempCET.csv';
let allData = null;
let yearFilter = { start: 1772, end: 2025 };

function loadAndPlot() {
    Papa.parse(currentDataset, {
        download: true, header: false, skipEmptyLines: true,
        complete: function(results) {
            allData = results.data;
            plotYearly(allData);
        }
    });
}

function applyYearFilter() {
    yearFilter.start = parseInt(document.getElementById('year-start').value);
    yearFilter.end = parseInt(document.getElementById('year-end').value);
    if (allData) {
        plotYearly(allData);
    }
}

// Event listeners
document.getElementById('dataset-select').addEventListener('change', e => {
    currentDataset = e.target.value;
    loadAndPlot();
});

// Add event listeners for checkboxes
document.getElementById('show-trend').addEventListener('change', e => {
    if (allData) {
        plotYearly(allData);
    }
});

document.getElementById('show-extremes').addEventListener('change', e => {
    if (allData) {
        plotYearly(allData);
    }
});

document.getElementById('show-data-points').addEventListener('change', e => {
    if (allData) {
        plotYearly(allData);
    }
});

document.getElementById('export-yearly-btn').onclick = function() {
    Plotly.downloadImage('cet-yearly', {
        format: 'png',
        filename: 'cet_annual_trends',
        height: 500, width: 1200, scale: 2
    });
};

// Initial load
loadAndPlot();
</script>
</body>
</html> 
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>England & Wales Precipitation Seasonal Totals</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<link rel="stylesheet" href="style.css">
<style>
.tab-buttons { margin-bottom: 1.5rem; display: flex; gap: 0.5rem; justify-content: center; }
.tab-btn { background: white; border: 2px solid #e1e8ed; padding: 0.75rem 1.5rem; font-weight: 600; cursor: pointer; font-size: 1rem; border-radius: 8px; transition: all 0.3s ease; color: #2c3e50; }
.tab-btn:hover { background: #f8f9fa; border-color: #667eea; }
.tab-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.plot-container { background: white; border-radius: 12px; padding: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem; }
#ewp-seasonal, #ewp-seasonal-print-image { width: 100%; height: 50vh; border-radius: 8px; }
.info-section { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem; }
.info-section h3 { color: #2c3e50; margin-bottom: 1rem; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; }
.info-section p { line-height: 1.6; color: #555; margin-bottom: 0.75rem; }
@media print { html, body { zoom: 0.75 !important; font-size: 10pt !important; } #ewp-seasonal { display: none !important; } #ewp-seasonal-print-image { display: block !important; page-break-inside: avoid; margin-bottom: 1em; } }
.season-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.season-card {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 1rem;
  border-left: 4px solid #667eea;
}

.season-card h4 {
  color: #2c3e50;
  margin-bottom: 0.5rem;
  font-size: 1.1rem;
}

.season-card p {
  margin: 0;
  font-size: 0.9rem;
  color: #666;
}
</style>
</head>
<body>
<div class="banner">
  <a href="index.html">
    <img src="logo.svg" alt="WeatherArchives Logo" class="banner-logo">
  </a>
</div>

<nav class="nav-bar">
  <div class="nav-item">
    <a href="temperature.html" class="nav-link">Temperature</a>
    <div class="dropdown">
      <a href="temperature.html">Overview</a>
      <a href="cet_mean_daily_extremes.html">Daily Extremes</a>
      <a href="cet_monthly_averages.html">Monthly Averages</a>
      <a href="cet_seasonal_patterns.html">Seasonal Patterns</a>
      <a href="cet_yearly_trends.html">Yearly Trends</a>
      <a href="cet_compare_years.html">Compare Years</a>
    </div>
  </div>
  <div class="nav-item">
    <a href="precipitation.html" class="nav-link">Precipitation</a>
    <div class="dropdown">
      <a href="precipitation.html">Overview</a>
      <a href="wip.html">Daily Totals</a>
      <a href="ewp_monthly_totals.html">Monthly Totals</a>
      <a href="ewp_seasonal_totals.html">Seasonal Totals</a>
      <a href="ewp_yearly_totals.html">Yearly Totals</a>
      <a href="wip.html">Compare Years</a>
      <a href="wip.html">Average Precipitation</a>
    </div>
  </div>
  <div class="nav-item">
    <a href="wip.html" class="nav-link">Sunshine</a>
    <div class="dropdown">
      <a href="wip.html">Monthly Hours</a>
      <a href="wip.html">Seasonal Hours</a>
      <a href="wip.html">Yearly Totals</a>
    </div>
  </div>
  <div class="nav-item">
    <a href="wip.html" class="nav-link">Fun & Learning</a>
    <div class="dropdown">
      <a href="wip.html">Creating your own weather forecast</a>
    </div>
  </div>
  <div class="nav-item">
    <a href="about.html" class="nav-link">About</a>
    <div class="dropdown">
      <a href="about.html">Data Sources</a>
      <a href="about.html">Methodology</a>
      <a href="about.html">References</a>
      <a href="about.html">Contact</a>
    </div>
  </div>
  <div class="nav-item">
    <a href="changelog.html" class="nav-link">Changelog</a>
  </div>
</nav>

<div class="title-banner">
  <h1>England & Wales Precipitation Seasonal Totals</h1>
  <p>Explore seasonal precipitation totals and trends over time</p>
  <p style="font-size: 0.8em; margin-top: 0.5rem; opacity: 0.8;">Data source: UK Met Office Hadley Centre (EWP) | <span id="last-updated">Loading data freshness...</span></p>
</div>

<div class="container">
  <div class="controls">
    <div class="control-group">
      <label>Season:</label>
      <select id="season-select">
        <option value="0">Spring (MAM)</option>
        <option value="1">Summer (JJA)</option>
        <option value="2">Autumn (SON)</option>
        <option value="3">Winter (DJF)</option>
      </select>
    </div>
    <div class="control-group">
      <label>Year Range:</label>
      <input type="number" id="year-start" min="1931" max="2025" value="1931" style="width: 80px;">
      <span style="color: #666;">to</span>
      <input type="number" id="year-end" min="1931" max="2025" value="2025" style="width: 80px;">
      <button onclick="applyYearFilter()">Apply Filter</button>
    </div>
    <button id="export-btn">Download Image</button>
    <button class="btn-primary print-btn" onclick="window.print()" style="margin-left: 0.5em;">Print Page</button>
  </div>
  <div class="controls">
    <div class="control-group">
      <label style="margin-right: 1rem;">Show:</label>
      <label style="margin-right: 1rem;">
        <input type="checkbox" id="show-trend" checked> Trend Line
      </label>
      <label style="margin-right: 1rem;">
        <input type="checkbox" id="show-extremes" checked> Max/Min Years
      </label>
      <label>
        <input type="checkbox" id="show-data-points" checked> Data Points
      </label>
    </div>
  </div>
  <div class="plot-container">
    <div id="ewp-seasonal-print-image" style="display:none; text-align:center; margin-bottom:1em;"></div>
    <div id="ewp-seasonal"></div>
  </div>
  <div class="info-section">
    <h3>Seasonal Precipitation Patterns</h3>
    <p>This section describes typical precipitation patterns for each season in England & Wales, helping you interpret the seasonal totals and trends above.</p>
    <div class="season-info">
      <div class="season-card">
        <h4>Spring (MAM)</h4>
        <p>Spring brings moderate rainfall spread fairly evenly across March, April, and May. Showers are frequent, especially in April, but longer dry spells are also common as temperatures rise.</p>
      </div>
      <div class="season-card">
        <h4>Summer (JJA)</h4>
        <p>Summer rainfall often comes in shorter bursts, with occasional heavy downpours and thunderstorms. Although there are fewer rainy days compared to other seasons, intense showers can contribute significantly to monthly totals.</p>
      </div>
      <div class="season-card">
        <h4>Autumn (SON)</h4>
        <p>Autumn is usually the wettest time of year, especially in October and November, when more prolonged rain and Atlantic weather systems are common. September often begins relatively dry before conditions turn wetter later in the season.</p>
      </div>
      <div class="season-card">
        <h4>Winter (DJF)</h4>
        <p>Winter features frequent, steady rainfall and persistently damp conditions. While snow can occur, most precipitation falls as rain, with saturated ground and prolonged wet periods typical through December and January.</p>
      </div>
    </div>
    <h3>How to Use This Visualization</h3>
    <p><strong>Interactive Features:</strong> Click on any data point to see detailed information about that year's seasonal precipitation. The visualization will show annotations with the exact year and precipitation value.</p>
    <p><strong>Trend Analysis:</strong> Look for long-term trends in each season. Are autumns getting wetter? Are summers becoming drier or more variable? The data allows for comprehensive analysis of seasonal rainfall patterns.</p>
    <p><strong>Seasonal Comparison:</strong> Compare how different seasons have changed over time. Some seasons may show more dramatic changes in precipitation than others.</p>
  </div>
</div>
<script>
const seasons = ["Spring (MAM)", "Summer (JJA)", "Autumn (SON)", "Winter (DJF)"];
const seasonColors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#9467bd'];
let currentSeason = 0;
let allData = null;
let yearFilter = { start: 1931, end: 2025 };

function parseFlexibleDate(dateStr) {
    if (!dateStr) return null;
    if (dateStr.includes('-')) { let dt = new Date(dateStr); if (!isNaN(dt)) return dt; }
    if (dateStr.includes('/')) {
        let dmy = dateStr.split('/'); if (dmy.length === 3) {
            let [dd, mm, yyyy] = dmy; dd=+dd; mm=+mm; yyyy=+yyyy;
            if (isNaN(dd) || isNaN(mm) || isNaN(yyyy)) return null;
            return new Date(yyyy, mm-1, dd);
        }
    }
    return null;
}

function linearRegression(x, y) {
    const n = x.length;
    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
    for (let i = 0; i < n; i++) {
        sumX += x[i];
        sumY += y[i];
        sumXY += x[i] * y[i];
        sumX2 += x[i] * x[i];
    }
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    return { slope, intercept };
}

function getSeason(dt) {
    const m = dt.getMonth();
    if (m >= 2 && m <= 4) return 0; // Spring: Mar, Apr, May
    if (m >= 5 && m <= 7) return 1; // Summer: Jun, Jul, Aug
    if (m >= 8 && m <= 10) return 2; // Autumn: Sep, Oct, Nov
    return 3; // Winter: Dec, Jan, Feb
}

function getSeasonYear(dt) {
    const y = dt.getFullYear(), m = dt.getMonth();
    if (m === 11) return y + 1; // Dec belongs to next year's winter
    return y;
}

function plotSeasonal(data, selectedSeason = 0) {
    let season_series = Array.from({length: 4}, () => ({}));
    data.forEach(row => {
        let dt = parseFlexibleDate(row[0]), v = parseFloat(row[1]);
        if (!dt || isNaN(v)) return;
        let y = getSeasonYear(dt), s = getSeason(dt);
        if (!season_series[s][y]) season_series[s][y] = [];
        season_series[s][y].push(v);
    });
    let years = [], values = [];
    Object.keys(season_series[selectedSeason]).sort((a,b)=>a-b).forEach(yr => {
        const year = +yr;
        if (year >= yearFilter.start && year <= yearFilter.end) {
            years.push(year);
            let vals = season_series[selectedSeason][yr];
            values.push(vals.reduce((a,b)=>a+b,0));
        }
    });
    let traces = [];
    if (document.getElementById('show-data-points').checked) {
        traces.push({
            x: years,
            y: values,
            mode: 'lines+markers',
            name: seasons[selectedSeason],
            line: { color: seasonColors[selectedSeason], width: 3 },
            marker: { size: 4, color: seasonColors[selectedSeason] }
        });
    } else {
        traces.push({
            x: years,
            y: values,
            mode: 'lines',
            name: seasons[selectedSeason],
            line: { color: seasonColors[selectedSeason], width: 3 }
        });
    }
    if (document.getElementById('show-trend').checked && years.length > 1) {
        const { slope, intercept } = linearRegression(years, values);
        const trendY = years.map(x => slope * x + intercept);
        traces.push({
            x: years,
            y: trendY,
            mode: 'lines',
            name: 'Trend Line',
            line: { color: 'red', width: 2, dash: 'dash' },
            showlegend: true
        });
    }
    if (document.getElementById('show-extremes').checked && values.length > 0) {
        const maxIndex = values.indexOf(Math.max(...values));
        const minIndex = values.indexOf(Math.min(...values));
        traces.push({
            x: [years[maxIndex]],
            y: [values[maxIndex]],
            mode: 'markers',
            name: 'Wettest Year',
            marker: {
                color: 'blue',
                size: 10,
                symbol: 'star',
                line: { color: 'black', width: 1 }
            },
            showlegend: true
        });
        traces.push({
            x: [years[minIndex]],
            y: [values[minIndex]],
            mode: 'markers',
            name: 'Driest Year',
            marker: {
                color: 'orange',
                size: 10,
                symbol: 'star',
                line: { color: 'black', width: 1 }
            },
            showlegend: true
        });
    }
    let layout = {
        title: `${seasons[selectedSeason]} Seasonal Total Precipitation (${yearFilter.start}-${yearFilter.end})`,
        xaxis: { title: 'Year', showgrid: true, zeroline: false },
        yaxis: { title: 'Seasonal Total Precipitation (mm)', showgrid: true, zeroline: false },
        height: 500,
        margin: { l: 60, r: 30, t: 60, b: 60 },
        hovermode: 'x unified',
        showlegend: true
    };
    Plotly.newPlot('ewp-seasonal', traces, layout, {responsive: true});
    let curAnn = null;
    document.getElementById('ewp-seasonal').on('plotly_click', d => {
        let pt = d.points[0], ann = {
            x: pt.x, y: pt.y,
            text: `<b>${pt.x}</b><br>${pt.y.toFixed(1)} mm`,
            showarrow: true,
            font: {color: seasonColors[selectedSeason]},
            arrowcolor: seasonColors[selectedSeason],
            ax: 0, ay: -30, bgcolor: '#fff'
        };
        let updates = curAnn ? {annotations: []} : {};
        Plotly.relayout('ewp-seasonal', updates);
        Plotly.relayout('ewp-seasonal', {annotations: [ann]});
        curAnn = ann;
    });
}

document.getElementById('season-select').addEventListener('change', e => {
    currentSeason = parseInt(e.target.value);
    if (allData) {
        plotSeasonal(allData, currentSeason);
    }
});

document.getElementById('show-trend').addEventListener('change', e => {
    if (allData) {
        plotSeasonal(allData, currentSeason);
    }
});
document.getElementById('show-extremes').addEventListener('change', e => {
    if (allData) {
        plotSeasonal(allData, currentSeason);
    }
});
document.getElementById('show-data-points').addEventListener('change', e => {
    if (allData) {
        plotSeasonal(allData, currentSeason);
    }
});

document.getElementById('export-btn').onclick = function() {
    Plotly.downloadImage('ewp-seasonal', {
        format: 'png',
        filename: `ewp_${seasons[currentSeason].toLowerCase().replace(/[^a-z]+/g,'_')}_totals`,
        height: 500, width: 1200, scale: 2
    });
};

function applyYearFilter() {
    yearFilter.start = parseInt(document.getElementById('year-start').value);
    yearFilter.end = parseInt(document.getElementById('year-end').value);
    if (allData) {
        plotSeasonal(allData, currentSeason);
    }
}

function loadAndPlot() {
    Papa.parse('PrecipitationEWP.csv', {
        download: true, header: false, skipEmptyLines: true,
        complete: function(results) {
            if (!results.data || results.data.length === 0) {
                document.getElementById('ewp-seasonal').innerHTML = '<div style="color:red;text-align:center;margin-top:2em;">PrecipitationEWP.csv not found or empty. Please check the data file.</div>';
                return;
            }
            allData = results.data;
            plotSeasonal(allData, currentSeason);
        },
        error: function(err) {
            document.getElementById('ewp-seasonal').innerHTML = '<div style="color:red;text-align:center;margin-top:2em;">Error loading PrecipitationEWP.csv: ' + err + '</div>';
        }
    });
}

function loadDataFreshness() {
    fetch('data_last_updated.txt')
        .then(response => response.text())
        .then(data => {
            const lastUpdated = data.trim();
            document.getElementById('last-updated').textContent = `Last updated: ${lastUpdated}`;
        })
        .catch(error => {
            document.getElementById('last-updated').textContent = 'Data freshness unavailable';
        });
}

window.addEventListener('DOMContentLoaded', function() {
    loadDataFreshness();
    loadAndPlot();
});

function preparePlotlyPrint() {
  var plot = document.getElementById('ewp-seasonal');
  var printImageDiv = document.getElementById('ewp-seasonal-print-image');
  if (plot && window.Plotly) {
    Plotly.toImage(plot, {format: 'png', width: 900, height: 500}).then(function(url) {
      printImageDiv.innerHTML = '<img src="' + url + '" style="max-width:100%;height:auto;">';
      plot.style.display = 'none';
      printImageDiv.style.display = 'block';
    });
  }
}
function restorePlotlyAfterPrint() {
  var plot = document.getElementById('ewp-seasonal');
  var printImageDiv = document.getElementById('ewp-seasonal-print-image');
  if (plot && printImageDiv) {
    plot.style.display = '';
    printImageDiv.style.display = 'none';
  }
}
if (window.matchMedia) {
  window.matchMedia('print').addEventListener('change', function(mql) {
    if (mql.matches) {
      preparePlotlyPrint();
    } else {
      restorePlotlyAfterPrint();
    }
  });
}
window.addEventListener('beforeprint', preparePlotlyPrint);
window.addEventListener('afterprint', restorePlotlyAfterPrint);
window.addEventListener('focus', function() {
  var printImageDiv = document.getElementById('ewp-seasonal-print-image');
  if (printImageDiv && printImageDiv.style.display === 'block') {
    restorePlotlyAfterPrint();
    setTimeout(restorePlotlyAfterPrint, 100);
  }
});
</script>
</body>
</html> 